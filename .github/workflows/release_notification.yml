name: Release Notification

on:
  release:
    types: [prereleased]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get Release Information
        id: get_release_info
        run: |
          RELEASE_BODY=$(echo "${{ github.event.release.body }}" | tr '\n' ' ')
          
          echo "RELEASE_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          echo "RELEASE_NAME=${{ github.event.release.name }}" >> $GITHUB_ENV
          echo "RELEASE_IS_PRERELEASE=${{ github.event.release.prerelease }}" >> $GITHUB_ENV
          echo "RELEASE_URL=${{ github.event.release.html_url }}" >> $GITHUB_ENV
          echo "RELEASE_BODY=$RELEASE_BODY" >> $GITHUB_ENV
          echo "REPOSITORY_OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "REPOSITORY_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV

      - name: Telegram Notification
        run: |
          RELEASE_STATUS="Release"
          if [ "$RELEASE_IS_PRERELEASE" == "true" ]; then
            RELEASE_STATUS="Pre-release"
          fi
          MESSAGE="**–ù–æ–≤–∏–π —Ä–µ–ª—ñ–∑ RaiderHub: $RELEASE_NAME ($RELEASE_STATUS)**\n\n"
          MESSAGE+="**–¢–µ–≥:** \`$RELEASE_TAG\`\n\n"
          MESSAGE+="**–ó–º—ñ–Ω–∏:**\n$RELEASE_BODY\n\n"
          MESSAGE+="**[üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ä–µ–ª—ñ–∑]($RELEASE_URL)**"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="MarkdownV2" \
            -d disable_web_page_preview=true

      - name: Discord Notification
        if: "${{ secrets.DISCORD_WEBHOOK_URL != '' }}"
        run: |
          RELEASE_STATUS="Release"
          if [ "$RELEASE_IS_PRERELEASE" == "true" ]; then
            RELEASE_STATUS="Pre-release"
          fi
          MESSAGE="**–ù–æ–≤–∏–π —Ä–µ–ª—ñ–∑ RaiderHub: $RELEASE_NAME ($RELEASE_STATUS)**\n\n"
          MESSAGE+="**–¢–µ–≥:** \`$RELEASE_TAG\`\n\n"
          MESSAGE+="**–ó–º—ñ–Ω–∏:**\n$RELEASE_BODY\n\n"
          MESSAGE+="**[üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ä–µ–ª—ñ–∑]($RELEASE_URL)**"
          curl -H "Content-Type: application/json" -X POST -d "{\"content\": \"$MESSAGE\"}" "${{ secrets.DISCORD_WEBHOOK_URL }}"

